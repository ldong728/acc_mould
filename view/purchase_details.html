<style>
    .attr-input{display: none; z-index: 99; position: fixed;left: 50%;top: 50%; width: 500px;height: 350px;padding: 30px;box-sizing: border-box; margin-left:  -250px;margin-top: -175px;background-color: #fff;}
</style>

<div class="home">
    <div class="container">
        <div class="pu-container">
            <div class="pu-breadcrumbs clearfix">
                <ul class="clearfix">
                    <li><a href="?href=index">首页</a></li>
                    <span>&gt;</span>
                    <li><a href="?href=purchase">我要采购</a></li>
                    <span>&gt;</span>
                    <li><a href="?href=purchase_details" class="product-inf" data-field="category_name"></a></li>
                </ul>
                <p class="number">共找到<span class="light">1234</span>信息</p>
            </div>
            <div class="pu-details">
                <div class="pu-details-info clearfix">
                    <div class="pd-info-l">
                        <p class="big-img"><img class="current-img" src="images/lm.jpg"></p>
                        <ul class="ul-img clearfix img-container">
                            <li class="img-template"><img class="small-image" src="images/lm.jpg"></li>
                        </ul>
                    </div>
                    <div class="pd-info-r">
                        <div class="pd-info-title clearfix">
                            <h2 class="product-inf" data-field="product_name">模具加工</h2>
                            <a href="?href=purchase_demand">发布采购需求</a>
                        </div>
                        <ol class="pd-info-number clearfix">
                            <li>
                                <p class="red">￥0.00</p>

                                <p class="num">/<span class="unit-name"></span></p>
                            </li>
                            <!--<li>-->
                                <!--<p class="red">￥95.00</p>-->

                                <!--<p class="num">100-4999台</p>-->
                            <!--</li>-->
                            <!--<li>-->
                                <!--<p class="red">￥90.00</p>-->

                                <!--<p class="num">≥5000台</p>-->
                            <!--</li>-->
                            <div class="down-load file-container" style="display: none">
                                <a class="upload-button" style="cursor: pointer"><p class="text">上传图纸</p></a>
                                <p class="content file-status" style="display: none"><span class="file-name"></span><a class="down-file-icon"><i class="cur-color icon icon-arrow-circle-o-down"></i></a></p>
                                <input type="file" class="file-value" style="display: none">
                            </div>
                        </ol>
                        <ul class="pd-info-content">
                            <!--<li>-->
                                <!--<p class="li-l">规格</p>-->

                                <!--<p class="li-r">这里是规格</p>-->
                            <!--</li>-->
                            <li>
                                <p class="li-l">发货地</p>

                                <p class="li-r product-inf" data-field="shipping_place">浙江省宁波市</p>
                            </li>
                            <li>
                                <p class="li-l">发货期</p>

                                <p class="li-r"><span class="light product-inf" data-field="delivery_time">3</span>天以内</p>
                            </li>
                            <li>
                                <p class="li-l">运费说明</p>

                                <p class="li-r product-inf" data-field="shipping_instr">买家承担</p>
                            </li>
                            <li>
                                <p class="li-l">支付方式</p>

                                <p class="li-r"><span>支付宝</span><span>微信</span><span>网上银行</span><span>PayPal</span></p>
                            </li>
                        </ul>
                        <div class="pd-info-shop clearfix">
                            <p class="li-l">订购数量</p>

                            <div class="shop-r">
                                <div class="top">
                                    <span class="less"><i class="icon icon-minus"></i></span><span>10</span><span
                                        class="plus"><i class="icon icon-plus"></i></span>
                                </div>
                                <div class="bottom">
                                    <button class="add-shop add-to-cart"><i class="icon icon-shopping-cart"></i>加入购物车
                                    </button>
                                    <a href="?href=purchase_demand" class="xj">立即询价</a>
                                    <button type="button" class="contact">联系信息</button>
                                </div>
                                <div class="density-mask">
                                    <div class="densitybox">
                                        <a href="javascript:void(0)" class="close" id="dm-close"><i
                                                class="icon icon-times-circle"></i></a>

                                        <div class="titbox calc-result-box"><span class="calc-result">0</span><span class="unit-name"></span></div>
                                        <div class="blur-box calc-value">
                                            <span class="attr-name">长</span><input type="text" value="0"
                                                                                   name="long" class="number-input"><span class="attr-unit">mm</span>
                                        </div>
                                        <a href="javascript:void(0)" class="d-m-add calc-button">加入购物车</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="pd-protection clearfix">
                            <p class="li-l">订购数量</p>
                            <div class="protection-r">
                                <img src="images/bao.png">
                                <span>卖家支持先行赔付，保障卖家交易安全</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="pu-details-parameter">
                    <ul class="clearfix">
                        <li class="li-cur detail-switch" data-field="product_detail">商品详情</li>
                        <li class="detail-switch" data-field="size_detail">规格参数</li>
                        <!--<li>联系方式</li>-->
                    </ul>
                    <div class="parameter-content">
                        <iframe class="detail-container">

                        </iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="contact-message">
    <h2 class="title">联系信息<i class="icon icon-remove"></i></h2>

    <div class="message">
        <p>
            <span class="img"><img src="images/co2.png"></span>手机号：<span class="red">13400000000</span>
        </p>

        <p>
            <span class="img"> <img src="images/co1.png"></span>电&nbsp;&nbsp;&nbsp;话：0574-68686868
        </p>

        <p>
            <span class="img">
                <img src="images/co3.png">
            </span>联系人：陈先生
        </p>

        <p>
            <span class="img">
                <img src="images/co4.png">
            </span>公&nbsp;&nbsp;&nbsp;司：<span class="product-inf" data-field="company_name">某某某公司（普通会员）</span>
        </p>

        <p>
            <span class="img">
                <img src="images/co5.png">
            </span>地&nbsp;&nbsp;&nbsp;址：<span class="product-inf" data-field="company_address">浙江省宁波市</span>
        </p>
    </div>
</div>

<script>
    var bodyHeight = $('body').height();
    $(function () {


        $(document).on('click', '.contact', function () {
            $('.contact-message').show();
            $('body').append('<div class="mask"></div>');
            $('.mask').height(bodyHeight);
        });

        $(document).on('click', '.mask', function () {
            $('.contact-message').hide();
            $('.attr-input').hide();
            $('.mask').remove();
        });

        $(document).on('click', '.contact-message', function () {
            $('.contact-message').hide();
            $('.mask').remove();
        });

//        $('.add-shop').click(function () {
//            $('.density-mask').css('display','block');
//        });

        $('#dm-close').click(function () {
            $('.density-mask').css('display','none');
        });
    });
</script>
<script>
    var productId=sessionStorage.currentProductId;
    var categoryAttr;
    var orderAttr={};
    var productInf;
    var calFunction;
    var inputCreator=prepareElement('.calc-value');
    var fileCreator=prepareElement('.file-value');
//    var pruduct_type=0;
    $(document).ready(function(){
        if(productId){
            initProductInf();
            registEvent();
        }
    });
    function registEvent(){
        $(document).on('click','.detail-switch',function(){
            console.log('click');
            $('.detail-switch').removeClass('li-cur');
            $(this).addClass('li-cur');
            var field=$(this).data('field');
//            $('.detail-container').attr('src','api.php/API/Product/')
            $('.parameter-content').html(productInf[field]);
        });
        $(document).on('click','.add-to-cart',function(){
            if($('.calc-value').length>0){
                $('.density-mask').css('display','block');
            }else if($('.file-value').length>0){
                var attrId=$('.file-value').attr('id').slice(4);
                if(!orderAttr[attrId].value){
                    alert(orderAttr[attrId].category_attr_name+"未上传");
                    return;
                }

            }

        });
        $(document).on('click','.upload-button',function(){
            console.log('up-log');
           $('.file-value').click();
        });
        $(document).on('click','.small-image',function(){
            var src=$(this).attr('src');
            $('.current-img').attr('src',src);
            console.log(src);
        });
//        $(document).on('click')
        $(document).on('click','.calc-button',function(){

        });
        $(document).on('change','.number-input',function(){
           var id=$(this).attr('id').slice(3);
            var value=$(this).val();
            orderAttr[id].value=value;
//            console.log(id);
            var result=calculateNumber();
            $('.calc-result').text(result.toFixed(2));
            console.log(result);
        });
    }
    function calculateNumber(){
        var parm=[];
        if(calFunction){
            for(var i in orderAttr){
                parm.push(orderAttr[i].value);
            }
            var result=calFunction(parm)
            return result;
        }else{
            return null;
        }
    }
    function initProductInf(){
        var _=this;
        ajaxPost('product','detail',{product_id:productId},function(back){
            var backValue=backHandle(back);
            if(backValue){
                categoryAttr=backValue.attrs;
                productInf=backValue.detail;
                $('.product-inf').each(function(k,v){
                    var field=$(this).data('field');
                    $(v).text(productInf[field]);
                    $(v).removeAttr('data-field');
                });
                $('.parameter-content').html(productInf.product_detail);
                $('.unit-name').text(productInf.unit_name);
                var img=JSON.parse(productInf.img);
                $('.current-img').attr('src',img['product-img'][0]);

                var imgCreator= _.prepareElement('.img-template');
                for(var i in img['product-img']){
                    var sImg=imgCreator();
                    sImg.find('.small-image').attr('src',img['product-img'][i]);
                    $('.img-container').append(sImg);
                }
                setAttrs(_);

//                console.log(categoryAttr);
//                console.log(attr);

            }
        });

    }
    function setAttrs(){
        var attr=JSON.parse(productInf.product_attr);
//        productAttr=attr;
//        return;
        for(var i in categoryAttr){
            if(attr[i])categoryAttr[i]=attr[i];
            if(4==categoryAttr[i].attr_pms){
                orderAttr[i]=categoryAttr[i];
                switch(categoryAttr[i].attr_type){
                    case'number':
                        var inputElement=inputCreator();
                        inputElement.find('.attr-name').text(categoryAttr[i].category_attr_name);
                        inputElement.find('.attr-unit').text(categoryAttr[i].attr_unit);
                        inputElement.find('input').attr('id','cal'+categoryAttr[i].category_attr_id);
                            $('.calc-result-box').after(inputElement);
                        break;

                    case'file':
                            console.log('file');
                        var fileElement=fileCreator();
                            fileElement.attr('name','file'+categoryAttr[i].category_attr_id);
                            fileElement.attr('id','file'+categoryAttr[i].category_attr_id);
                            $('.file-container').append(fileElement);
                            $('.file-container').show();
                            setUploadEvent('#file'+categoryAttr[i].category_attr_id,uploadSuccess,uploadFail);
                        break;
                    default:
                        break;
                }
            }
            if('func'==categoryAttr[i].attr_type){
                console.log('func');
                calFunction=eval('('+categoryAttr[i].value+')');
                break;
            }

        }
    }
    function uploadSuccess(back){
        if('SUCCESS'==back.state){
            var orderAttrId=$('.file-value').attr('id').slice(4);
            $('.file-name').text('图纸'+back.type);
            $('.down-file-icon').attr('href',back.url);
            $('.file-status').show();
            orderAttr[orderAttrId].value=back.url;
            console.log(back);
        }else{
            alert(back.state);
        }
    }
    function uploadFail(back){
        console.log(back);
        alert('error');
//        alert(back.)
    }



</script>